<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>مهمة الروابط المختصرة | Am Rewards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: 'Tajawal', sans-serif;
      background: #f1fdf6;
      margin: 0;
      padding: 20px;
    }
    h2 {
      color: #28a745;
      text-align: center;
    }
    .stats {
      text-align: center;
      margin-bottom: 20px;
    }
    .link-box {
      background: white;
      padding: 15px;
      border: 1px solid #ccc;
      margin: 10px auto;
      max-width: 400px;
      border-radius: 12px;
      text-align: center;
    }
    .link-box a {
      color: #007bff;
      text-decoration: none;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>مهمة الروابط المختصرة</h2>
  <div class="stats">
    <p>عدد الروابط المنفذة: <span id="doneCount">0</span></p>
    <p>عدد الروابط المتبقية: <span id="remainingCount">0</span></p>
    <p>النقاط المكتسبة: <span id="earnedPoints">0</span> نقطة</p>
  </div>
  <div id="linksContainer"></div>  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import {
      getAuth,
      onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc,
      setDoc
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBfOJPkWbmcJ6s29bDNysr-H0Kx-Js3Gy0",
      authDomain: "am--rewards.firebaseapp.com",
      projectId: "am--rewards"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const shortLinks = Array.from({ length: 100 }, (_, i) => ({
      id: `link${i + 1}`,
      url: `https://link-target.net/your-link-${i + 1}`,
      points: 7.15
    }));

    let userId = null;
    let completed = [];

    onAuthStateChanged(auth, async (user) => {
      if (!user) return alert('يرجى تسجيل الدخول أولاً.');
      userId = user.uid;
      const userRef = doc(db, 'users', userId);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists()) {
        await setDoc(userRef, { points: 0, shortlinks: [] });
      }

      completed = userSnap.data().shortlinks || [];
      renderLinks();
    });

    async function handleClick(link) {
      if (completed.includes(link.id)) return;

      completed.push(link.id);
      const userRef = doc(db, 'users', userId);
      const userSnap = await getDoc(userRef);
      const oldPoints = userSnap.data().points || 0;
      await updateDoc(userRef, {
        points: oldPoints + link.points,
        shortlinks: completed
      });
      renderLinks();
    }

    function renderLinks() {
      const container = document.getElementById('linksContainer');
      container.innerHTML = '';

      shortLinks.forEach(link => {
        const div = document.createElement('div');
        div.className = 'link-box';
        div.innerHTML = completed.includes(link.id)
          ? `<p>✅ تم فتح الرابط</p>`
          : `<p>رابط ${link.id}</p><a href="${link.url}" target="_blank" onclick="handleLink('${link.id}')">افتح الرابط</a>`;
        container.appendChild(div);
      });

      document.getElementById('doneCount').textContent = completed.length;
      document.getElementById('remainingCount').textContent = shortLinks.length - completed.length;
      document.getElementById('earnedPoints').textContent = (completed.length * 7.15).toFixed(2);
    }

    window.handleLink = async function (id) {
      const link = shortLinks.find(l => l.id === id);
      handleClick(link);
    }
  </script></body>
</html>
